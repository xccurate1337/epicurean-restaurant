from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth import login
from django.contrib import messages
from django.http import JsonResponse
from django.db.models import Q, Avg, Count
from django.core.cache import cache
from .models import *
import json


# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
def register(request):
    if request.method == 'POST':
        form = UserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            login(request, user)
            messages.success(request, 'üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≠–ø–∏–∫—É—Ä–µ–π!')
            return redirect('home')
    else:
        form = UserCreationForm()

    return render(request, 'registration/register.html', {'form': form})


# –ì–ª–∞–≤–Ω–∞—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
def home(request):
    query = request.GET.get('q', '')
    –∫–∞—Ç–µ–≥–æ—Ä–∏—è = request.GET.get('–∫–∞—Ç–µ–≥–æ—Ä–∏—è', '')
    —Ç–∏–ø_–±–ª—é–¥–∞ = request.GET.get('—Ç–∏–ø', '')
    –º–∏–Ω_—Ü–µ–Ω–∞ = request.GET.get('–º–∏–Ω_—Ü–µ–Ω–∞', '')
    –º–∞–∫—Å_—Ü–µ–Ω–∞ = request.GET.get('–º–∞–∫—Å_—Ü–µ–Ω–∞', '')
    —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ = request.GET.get('—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞', '–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å')

    –±–ª—é–¥–∞ = –ë–ª—é–¥–æ.objects.filter(–∞–∫—Ç–∏–≤–Ω–æ=True)

    # –ü–æ–∏—Å–∫
    if query:
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.filter(
            Q(–Ω–∞–∑–≤–∞–Ω–∏–µ__icontains=query) |
            Q(–æ–ø–∏—Å–∞–Ω–∏–µ__icontains=query) |
            Q(—Å–æ—Å—Ç–∞–≤__icontains=query) |
            Q(—Ç–µ–≥–∏__contains=[query])
        )

    # –§–∏–ª—å—Ç—Ä—ã
    if –∫–∞—Ç–µ–≥–æ—Ä–∏—è:
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.filter(–∫–∞—Ç–µ–≥–æ—Ä–∏—è__slug=–∫–∞—Ç–µ–≥–æ—Ä–∏—è)
    if —Ç–∏–ø_–±–ª—é–¥–∞:
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.filter(—Ç–∏–ø_–±–ª—é–¥–∞=—Ç–∏–ø_–±–ª—é–¥–∞)
    if –º–∏–Ω_—Ü–µ–Ω–∞:
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.filter(—Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞__gte=–º–∏–Ω_—Ü–µ–Ω–∞)
    if –º–∞–∫—Å_—Ü–µ–Ω–∞:
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.filter(—Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞__lte=–º–∞–∫—Å_—Ü–µ–Ω–∞)

    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    if —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ == '—Ü–µ–Ω–∞_–≤–æ–∑—Ä':
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.order_by('—Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞')
    elif —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ == '—Ü–µ–Ω–∞_—É–±—ã–≤':
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.order_by('-—Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞')
    elif —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ == '—Ä–µ–π—Ç–∏–Ω–≥':
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.annotate(avg_rating=Avg('–æ—Ç–∑—ã–≤—ã__—Ä–µ–π—Ç–∏–Ω–≥')).order_by('-avg_rating')
    else:
        –±–ª—é–¥–∞ = –±–ª—é–¥–∞.order_by('–∫–∞—Ç–µ–≥–æ—Ä–∏—è__–Ω–∞–∑–≤–∞–Ω–∏–µ', '-–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å', '–Ω–∞–∑–≤–∞–Ω–∏–µ')  # –°–Ω–∞—á–∞–ª–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

    –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ = –ö–∞—Ç–µ–≥–æ—Ä–∏—è.objects.filter(–∞–∫—Ç–∏–≤–Ω–æ=True)

    context = {
        'dishes': –±–ª—é–¥–∞,
        '–∫–∞—Ç–µ–≥–æ—Ä–∏–∏': –∫–∞—Ç–µ–≥–æ—Ä–∏–∏,
        'query': query,
        'selected_filters': {
            '–∫–∞—Ç–µ–≥–æ—Ä–∏—è': –∫–∞—Ç–µ–≥–æ—Ä–∏—è,
            '—Ç–∏–ø': —Ç–∏–ø_–±–ª—é–¥–∞,
            '–º–∏–Ω_—Ü–µ–Ω–∞': –º–∏–Ω_—Ü–µ–Ω–∞,
            '–º–∞–∫—Å_—Ü–µ–Ω–∞': –º–∞–∫—Å_—Ü–µ–Ω–∞,
            '—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞': —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        }
    }
    return render(request, 'home.html', context)


# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–ª—é–¥–∞
def dish_detail(request, slug):
    –±–ª—é–¥–æ = get_object_or_404(–ë–ª—é–¥–æ, slug=slug, –∞–∫—Ç–∏–≤–Ω–æ=True)

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ
    –±–ª—é–¥–æ.–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å += 1
    –±–ª—é–¥–æ.save()

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–∑—ã–≤—ã
    –æ—Ç–∑—ã–≤—ã = –±–ª—é–¥–æ.–æ—Ç–∑—ã–≤—ã.all().select_related('–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')

    # –ü–æ—Ö–æ–∂–∏–µ –±–ª—é–¥–∞
    –ø–æ—Ö–æ–∂–∏–µ = –ë–ª—é–¥–æ.objects.filter(
        –∫–∞—Ç–µ–≥–æ—Ä–∏—è=–±–ª—é–¥–æ.–∫–∞—Ç–µ–≥–æ—Ä–∏—è,
        –∞–∫—Ç–∏–≤–Ω–æ=True
    ).exclude(id=–±–ª—é–¥–æ.id).order_by('-–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å')[:4]

    context = {
        'dish': –±–ª—é–¥–æ,
        '–æ—Ç–∑—ã–≤—ã': –æ—Ç–∑—ã–≤—ã,
        '–ø–æ—Ö–æ–∂–∏–µ': –ø–æ—Ö–æ–∂–∏–µ
    }
    return render(request, 'bludo.html', context)


# –ö–û–†–ó–ò–ù–ê
@login_required
def –∫–æ—Ä–∑–∏–Ω–∞(request):
    –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, created = –ö–æ—Ä–∑–∏–Ω–∞.objects.get_or_create(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user)
    —ç–ª–µ–º–µ–Ω—Ç—ã = –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.—ç–ª–µ–º–µ–Ω—Ç—ã.all().select_related('–±–ª—é–¥–æ')

    if request.method == 'POST':
        –¥–µ–π—Å—Ç–≤–∏–µ = request.POST.get('–¥–µ–π—Å—Ç–≤–∏–µ')
        –±–ª—é–¥–æ_id = request.POST.get('–±–ª—é–¥–æ_id')

        if –¥–µ–π—Å—Ç–≤–∏–µ == '–¥–æ–±–∞–≤–∏—Ç—å':
            –±–ª—é–¥–æ = get_object_or_404(–ë–ª—é–¥–æ, id=–±–ª—é–¥–æ_id)
            —ç–ª–µ–º–µ–Ω—Ç, created = –≠–ª–µ–º–µ–Ω—Ç–ö–æ—Ä–∑–∏–Ω—ã.objects.get_or_create(
                –∫–æ—Ä–∑–∏–Ω–∞=–∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
                –±–ª—é–¥–æ=–±–ª—é–¥–æ,
                defaults={'–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ': 1}
            )
            if not created:
                —ç–ª–µ–º–µ–Ω—Ç.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ += 1
                —ç–ª–µ–º–µ–Ω—Ç.save()
            messages.success(request, f'{–±–ª—é–¥–æ.–Ω–∞–∑–≤–∞–Ω–∏–µ} –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É!')

        elif –¥–µ–π—Å—Ç–≤–∏–µ == '—É–¥–∞–ª–∏—Ç—å':
            —ç–ª–µ–º–µ–Ω—Ç = get_object_or_404(–≠–ª–µ–º–µ–Ω—Ç–ö–æ—Ä–∑–∏–Ω—ã, id=–±–ª—é–¥–æ_id, –∫–æ—Ä–∑–∏–Ω–∞=–∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            —ç–ª–µ–º–µ–Ω—Ç.delete()
            messages.success(request, '–ë–ª—é–¥–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã')

        elif –¥–µ–π—Å—Ç–≤–∏–µ == '–æ–±–Ω–æ–≤–∏—Ç—å':
            —ç–ª–µ–º–µ–Ω—Ç = get_object_or_404(–≠–ª–µ–º–µ–Ω—Ç–ö–æ—Ä–∑–∏–Ω—ã, id=–±–ª—é–¥–æ_id, –∫–æ—Ä–∑–∏–Ω–∞=–∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            –Ω–æ–≤–æ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = int(request.POST.get('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 1))
            if –Ω–æ–≤–æ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ > 0:
                —ç–ª–µ–º–µ–Ω—Ç.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = –Ω–æ–≤–æ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                —ç–ª–µ–º–µ–Ω—Ç.save()
            else:
                —ç–ª–µ–º–µ–Ω—Ç.delete()

    return render(request, '–∫–æ—Ä–∑–∏–Ω–∞.html', {
        '–∫–æ—Ä–∑–∏–Ω–∞': –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
        '—ç–ª–µ–º–µ–Ω—Ç—ã': —ç–ª–µ–º–µ–Ω—Ç—ã
    })


# AJAX –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
@login_required
def –¥–æ–±–∞–≤–∏—Ç—å_–≤_–∫–æ—Ä–∑–∏–Ω—É(request, dish_id):
    if request.method == 'POST' and request.headers.get('x-requested-with') == 'XMLHttpRequest':
        –±–ª—é–¥–æ = get_object_or_404(–ë–ª—é–¥–æ, id=dish_id)
        –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, created = –ö–æ—Ä–∑–∏–Ω–∞.objects.get_or_create(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user)

        —ç–ª–µ–º–µ–Ω—Ç, created = –≠–ª–µ–º–µ–Ω—Ç–ö–æ—Ä–∑–∏–Ω—ã.objects.get_or_create(
            –∫–æ—Ä–∑–∏–Ω–∞=–∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
            –±–ª—é–¥–æ=–±–ª—é–¥–æ,
            defaults={'–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ': 1}
        )

        if not created:
            —ç–ª–µ–º–µ–Ω—Ç.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ += 1
            —ç–ª–µ–º–µ–Ω—Ç.save()

        return JsonResponse({
            'success': True,
            '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–≤_–∫–æ—Ä–∑–∏–Ω–µ': –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø–æ–∑–∏—Ü–∏–π,
            '—Å–æ–æ–±—â–µ–Ω–∏–µ': f'{–±–ª—é–¥–æ.–Ω–∞–∑–≤–∞–Ω–∏–µ} –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É!'
        })

    return JsonResponse({'success': False})


# –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê
@login_required
def –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ_–∑–∞–∫–∞–∑–∞(request):
    –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = get_object_or_404(–ö–æ—Ä–∑–∏–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user)
    —ç–ª–µ–º–µ–Ω—Ç—ã = –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.—ç–ª–µ–º–µ–Ω—Ç—ã.all()

    if not —ç–ª–µ–º–µ–Ω—Ç—ã:
        messages.error(request, '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!')
        return redirect('–∫–æ—Ä–∑–∏–Ω–∞')

    if request.method == 'POST':
        –∏–º—è = request.POST.get('–∏–º—è')
        —Ç–µ–ª–µ—Ñ–æ–Ω = request.POST.get('—Ç–µ–ª–µ—Ñ–æ–Ω')
        –∞–¥—Ä–µ—Å = request.POST.get('–∞–¥—Ä–µ—Å')
        –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π = request.POST.get('–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', '')
        —Å–ø–æ—Å–æ–±_–æ–ø–ª–∞—Ç—ã = request.POST.get('—Å–ø–æ—Å–æ–±_–æ–ø–ª–∞—Ç—ã', '–Ω–∞–ª–∏—á–Ω—ã–µ')
        –ø—Ä–æ–º–æ–∫–æ–¥ = request.POST.get('–ø—Ä–æ–º–æ–∫–æ–¥', '')

        # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
        –∑–∞–∫–∞–∑ = –ó–∞–∫–∞–∑.objects.create(
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user,
            –∏–º—è_–∫–ª–∏–µ–Ω—Ç–∞=–∏–º—è,
            —Ç–µ–ª–µ—Ñ–æ–Ω=—Ç–µ–ª–µ—Ñ–æ–Ω,
            –∞–¥—Ä–µ—Å=–∞–¥—Ä–µ—Å,
            –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π=–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π,
            —Å–ø–æ—Å–æ–±_–æ–ø–ª–∞—Ç—ã=—Å–ø–æ—Å–æ–±_–æ–ø–ª–∞—Ç—ã
        )

        # –ü–µ—Ä–µ–Ω–æ—Å–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –≤ –∑–∞–∫–∞–∑
        –æ–±—â–∞—è_—Å—É–º–º–∞ = 0
        for —ç–ª–µ–º–µ–Ω—Ç in —ç–ª–µ–º–µ–Ω—Ç—ã:
            –≠–ª–µ–º–µ–Ω—Ç–ó–∞–∫–∞–∑–∞.objects.create(
                –∑–∞–∫–∞–∑=–∑–∞–∫–∞–∑,
                –±–ª—é–¥–æ=—ç–ª–µ–º–µ–Ω—Ç.–±–ª—é–¥–æ,
                –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ=—ç–ª–µ–º–µ–Ω—Ç.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ,
                —Ü–µ–Ω–∞_–Ω–∞_–º–æ–º–µ–Ω—Ç=—ç–ª–µ–º–µ–Ω—Ç.–±–ª—é–¥–æ.—Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞
            )
            –æ–±—â–∞—è_—Å—É–º–º–∞ += —ç–ª–µ–º–µ–Ω—Ç.–ø–æ–¥–∏—Ç–æ–≥

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
        —Å–∫–∏–¥–∫–∞ = 0
        if –ø—Ä–æ–º–æ–∫–æ–¥:
            try:
                –ø—Ä–æ–º–æ = –ü—Ä–æ–º–æ–∫–æ–¥.objects.get(–∫–æ–¥=–ø—Ä–æ–º–æ–∫–æ–¥.upper(), –∞–∫—Ç–∏–≤–Ω–æ=True)
                if –ø—Ä–æ–º–æ.–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω and –æ–±—â–∞—è_—Å—É–º–º–∞ >= –ø—Ä–æ–º–æ.–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è_—Å—É–º–º–∞:
                    —Å–∫–∏–¥–∫–∞ = –æ–±—â–∞—è_—Å—É–º–º–∞ * –ø—Ä–æ–º–æ.—Å–∫–∏–¥–∫–∞ / 100
                    –ø—Ä–æ–º–æ.–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ += 1
                    –ø—Ä–æ–º–æ.save()
            except –ü—Ä–æ–º–æ–∫–æ–¥.DoesNotExist:
                pass

        –∑–∞–∫–∞–∑.–æ–±—â–∞—è_—Å—É–º–º–∞ = –æ–±—â–∞—è_—Å—É–º–º–∞ - —Å–∫–∏–¥–∫–∞
        –∑–∞–∫–∞–∑.save()

        # –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        —ç–ª–µ–º–µ–Ω—Ç—ã.delete()

        messages.success(request, f'–ó–∞–∫–∞–∑ #{–∑–∞–∫–∞–∑.id} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!')
        return redirect('–∏—Å—Ç–æ—Ä–∏—è_–∑–∞–∫–∞–∑–æ–≤')

    return render(request, '–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ_–∑–∞–∫–∞–∑–∞.html', {
        '–∫–æ—Ä–∑–∏–Ω–∞': –∫–æ—Ä–∑–∏–Ω–∞_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
        '—ç–ª–µ–º–µ–Ω—Ç—ã': —ç–ª–µ–º–µ–Ω—Ç—ã
    })


# –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í
@login_required
def –∏—Å—Ç–æ—Ä–∏—è_–∑–∞–∫–∞–∑–æ–≤(request):
    –∑–∞–∫–∞–∑—ã = –ó–∞–∫–∞–∑.objects.filter(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user).order_by('-—Å–æ–∑–¥–∞–Ω–æ')
    return render(request, '–∏—Å—Ç–æ—Ä–∏—è_–∑–∞–∫–∞–∑–æ–≤.html', {'–∑–∞–∫–∞–∑—ã': –∑–∞–∫–∞–∑—ã})


# –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
@login_required
def –¥–µ—Ç–∞–ª–∏_–∑–∞–∫–∞–∑–∞(request, order_id):
    –∑–∞–∫–∞–∑ = get_object_or_404(–ó–∞–∫–∞–∑, id=order_id, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user)
    return render(request, '–¥–µ—Ç–∞–ª–∏_–∑–∞–∫–∞–∑–∞.html', {'–∑–∞–∫–∞–∑': –∑–∞–∫–∞–∑})


# –û–¢–ó–´–í–´
@login_required
def –¥–æ–±–∞–≤–∏—Ç—å_–æ—Ç–∑—ã–≤(request, dish_id):
    if request.method == 'POST':
        –±–ª—é–¥–æ = get_object_or_404(–ë–ª—é–¥–æ, id=dish_id)
        —Ä–µ–π—Ç–∏–Ω–≥ = request.POST.get('—Ä–µ–π—Ç–∏–Ω–≥')
        –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π = request.POST.get('–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', '')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ —É–∂–µ –æ—Ç–∑—ã–≤
        —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π_–æ—Ç–∑—ã–≤ = –û—Ç–∑—ã–≤.objects.filter(
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user,
            –±–ª—é–¥–æ=–±–ª—é–¥–æ
        ).first()

        if —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π_–æ—Ç–∑—ã–≤:
            —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π_–æ—Ç–∑—ã–≤.—Ä–µ–π—Ç–∏–Ω–≥ = —Ä–µ–π—Ç–∏–Ω–≥
            —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π_–æ—Ç–∑—ã–≤.–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π = –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π_–æ—Ç–∑—ã–≤.save()
            messages.info(request, '–í–∞—à –æ—Ç–∑—ã–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!')
        else:
            –û—Ç–∑—ã–≤.objects.create(
                –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user,
                –±–ª—é–¥–æ=–±–ª—é–¥–æ,
                —Ä–µ–π—Ç–∏–Ω–≥=—Ä–µ–π—Ç–∏–Ω–≥,
                –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π=–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            )
            messages.success(request, '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!')

        return redirect('dish_detail', slug=–±–ª—é–¥–æ.slug)

    return redirect('home')


# –ò–ó–ë–†–ê–ù–ù–û–ï
@login_required
def –∏–∑–±—Ä–∞–Ω–Ω–æ–µ(request):
    –∏–∑–±—Ä–∞–Ω–Ω—ã–µ = –ò–∑–±—Ä–∞–Ω–Ω–æ–µ.objects.filter(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user).select_related('–±–ª—é–¥–æ')
    return render(request, '–∏–∑–±—Ä–∞–Ω–Ω–æ–µ.html', {'–∏–∑–±—Ä–∞–Ω–Ω—ã–µ': –∏–∑–±—Ä–∞–Ω–Ω—ã–µ})


@login_required
def –¥–æ–±–∞–≤–∏—Ç—å_–≤_–∏–∑–±—Ä–∞–Ω–Ω–æ–µ(request, dish_id):
    –±–ª—é–¥–æ = get_object_or_404(–ë–ª—é–¥–æ, id=dish_id)
    –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, created = –ò–∑–±—Ä–∞–Ω–Ω–æ–µ.objects.get_or_create(
        –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=request.user,
        –±–ª—é–¥–æ=–±–ª—é–¥–æ
    )

    if created:
        messages.success(request, f'{–±–ª—é–¥–æ.–Ω–∞–∑–≤–∞–Ω–∏–µ} –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!')
    else:
        –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.delete()
        messages.info(request, f'{–±–ª—é–¥–æ.–Ω–∞–∑–≤–∞–Ω–∏–µ} —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ')

    return redirect(request.META.get('HTTP_REFERER', 'home'))


# –ü–†–û–§–ò–õ–¨
@login_required
def –ø—Ä–æ—Ñ–∏–ª—å(request):
    –ø—Ä–æ—Ñ–∏–ª—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = request.user.–ø—Ä–æ—Ñ–∏–ª—å

    if request.method == 'POST':
        –ø—Ä–æ—Ñ–∏–ª—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.—Ç–µ–ª–µ—Ñ–æ–Ω = request.POST.get('—Ç–µ–ª–µ—Ñ–æ–Ω', '')
        –ø—Ä–æ—Ñ–∏–ª—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.–∞–¥—Ä–µ—Å = request.POST.get('–∞–¥—Ä–µ—Å', '')
        –¥–∞—Ç–∞_—Ä–æ–∂–¥–µ–Ω–∏—è = request.POST.get('–¥–∞—Ç–∞_—Ä–æ–∂–¥–µ–Ω–∏—è', '')
        if –¥–∞—Ç–∞_—Ä–æ–∂–¥–µ–Ω–∏—è:
            –ø—Ä–æ—Ñ–∏–ª—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.–¥–∞—Ç–∞_—Ä–æ–∂–¥–µ–Ω–∏—è = –¥–∞—Ç–∞_—Ä–æ–∂–¥–µ–Ω–∏—è
        –ø—Ä–æ—Ñ–∏–ª—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.save()

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        request.user.first_name = request.POST.get('–∏–º—è', '')
        request.user.last_name = request.POST.get('—Ñ–∞–º–∏–ª–∏—è', '')
        request.user.email = request.POST.get('email', '')
        request.user.save()

        messages.success(request, '–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!')
        return redirect('–ø—Ä–æ—Ñ–∏–ª—å')

    return render(request, '–ø—Ä–æ—Ñ–∏–ª—å.html', {'–ø—Ä–æ—Ñ–∏–ª—å': –ø—Ä–æ—Ñ–∏–ª—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è})


# –ê–ö–¶–ò–ò
def promotions(request):
    –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ_–±–ª—é–¥–∞ = –ë–ª—é–¥–æ.objects.filter(–∞–∫—Ü–∏—è=True, –∞–∫—Ç–∏–≤–Ω–æ=True)
    –ø—Ä–æ–º–æ–∫–æ–¥—ã = –ü—Ä–æ–º–æ–∫–æ–¥.objects.filter(–∞–∫—Ç–∏–≤–Ω–æ=True)

    return render(request, 'akciya.html', {
        'promotion_dishes': –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ_–±–ª—é–¥–∞,
        '–ø—Ä–æ–º–æ–∫–æ–¥—ã': –ø—Ä–æ–º–æ–∫–æ–¥—ã
    })


# –ü–û–ò–°–ö –° AJAX
def –ø–æ–∏—Å–∫(request):
    query = request.GET.get('q', '')
    if query:
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã = –ë–ª—é–¥–æ.objects.filter(
            Q(–Ω–∞–∑–≤–∞–Ω–∏–µ__icontains=query) |
            Q(–æ–ø–∏—Å–∞–Ω–∏–µ__icontains=query) |
            Q(—Ç–µ–≥–∏__contains=[query]),
            –∞–∫—Ç–∏–≤–Ω–æ=True
        )[:10]

        –¥–∞–Ω–Ω—ã–µ = [{
            'id': –±–ª—é–¥–æ.id,
            '–Ω–∞–∑–≤–∞–Ω–∏–µ': –±–ª—é–¥–æ.–Ω–∞–∑–≤–∞–Ω–∏–µ,
            '—Ü–µ–Ω–∞': float(–±–ª—é–¥–æ.—Ç–µ–∫—É—â–∞—è_—Ü–µ–Ω–∞),
            '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ': –±–ª—é–¥–æ.–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ,
            'url': –±–ª—é–¥–æ.get_absolute_url()
        } for –±–ª—é–¥–æ in —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã]

        return JsonResponse({'—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã': –¥–∞–Ω–Ω—ã–µ})

    return JsonResponse({'—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã': []})


# –ö—ç—à–∏—Ä—É–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –±–ª—é–¥–∞
def –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ_–±–ª—é–¥–∞():
    cache_key = '–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ_–±–ª—é–¥–∞'
    –±–ª—é–¥–∞ = cache.get(cache_key)
    if not –±–ª—é–¥–∞:
        –±–ª—é–¥–∞ = –ë–ª—é–¥–æ.objects.filter(–∞–∫—Ç–∏–≤–Ω–æ=True).order_by('-–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å')[:8]
        cache.set(cache_key, –±–ª—é–¥–∞, 3600)  # –ö—ç—à –Ω–∞ 1 —á–∞—Å
    return –±–ª—é–¥–∞